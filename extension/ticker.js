"use strict";

module.exports = function (nodecg) {
    const template = [{
        message: "Welcome to the Zelda Dungeon Marathon!"
    }, {
        template: "games"
    }, {
        message: "Donate toward Black Girls CODE - tinyurl.com/zdm20donate - Pick a filename you want us to use under Rewards"
    }, {
        template: "incentives"
    }];

    const queue = [];

    const ticker = nodecg.Replicant("ticker", {
        defaultValue: {
            enabled: false,
            duration: 10000,
            tick: 0,
            lines: []
        }
    });

    const message = nodecg.Replicant("message", {
        defaultValue: { message: "" }
    });

    const runs = nodecg.Replicant("runs", {
        defaultValue: {"start":{"next":"Master Quest","current":"Four Swords Adventures"},"Oracle of Seasons":{"rules":"Race","racers":[{"name":"Josh","checkpoint":0,"splits":[],"finish":11367,"checkpoints":[],"warning":false,"eliminated":false,"state":"","filename":"Josh"},{"name":"Mases","checkpoint":0,"splits":[],"finish":14460,"checkpoints":[],"warning":false,"eliminated":false,"state":"","filename":"NoMas"}],"incentives":[{"name":"Filename","options":{}}],"name":"Oracle of Seasons","abbr":"OoS","game":"The Legend of Zelda: Oracle of Seasons","twitch":{"id":"5406","name":"The Legend of Zelda: Oracle of Seasons","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Oracle%20of%20Seasons-{width}x{height}.jpg"},"next":"Four Swords Adventures","state":"done","finish":14460},"Four Swords Adventures":{"rules":"Race","racers":[{"name":"Sav","position":0,"checkpoint":0,"splits":[]},{"name":"Ashley","position":0,"checkpoint":0,"splits":[]},{"name":"Alasyn","position":0,"checkpoint":0,"splits":[]},{"name":"Katie","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Four Swords Adventures","abbr":"FSA","game":"The Legend of Zelda: Four Swords Adventures","twitch":{"id":"7200","name":"The Legend of Zelda: Four Swords Adventures","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Four%20Swords%20Adventures-{width}x{height}.jpg"},"next":"Master Quest","state":"running"},"Cadence of Hyrule":{"rules":"Race","racers":[{"name":"Andy","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Cadence of Hyrule","abbr":"CoH","game":"Cadence of Hyrule – Crypt of the NecroDancer Featuring The Legend of Zelda","twitch":{"id":"511968","name":"Cadence of Hyrule – Crypt of the NecroDancer Featuring The Legend of Zelda","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/Cadence%20of%20Hyrule%20%E2%80%93%20Crypt%20of%20the%20NecroDancer%20Featuring%20The%20Legend%20of%20Zelda-{width}x{height}.jpg"},"next":"Legend of Zelda"},"Wand of Gamelon":{"rules":"Race","racers":[{"name":"Kevin","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Wand of Gamelon","abbr":"WoG","game":"Zelda: The Wand of Gamelon","twitch":{"id":"16246","name":"Zelda: The Wand of Gamelon","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./Zelda:%20The%20Wand%20of%20Gamelon-{width}x{height}.jpg"},"next":"Hyrule Warriors"},"Link to the Past":{"rules":"Race","racers":[{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Kevin","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{}}],"name":"Link to the Past","abbr":"LttP","game":"The Legend of Zelda: A Link to the Past","twitch":{"id":"9435","name":"The Legend of Zelda: A Link to the Past","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20A%20Link%20to%20the%20Past-{width}x{height}.jpg"},"next":"Four Swords"},"Minish Cap":{"rules":"Elimination","racers":[{"name":"Kevin","position":0,"checkpoint":0,"splits":[]},{"name":"Locke","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]},{"name":"Rachel","position":0,"checkpoint":0,"splits":[]},{"name":"Andrew","position":0,"checkpoint":0,"splits":[]},{"name":"Joel","position":0,"checkpoint":0,"splits":[]},{"name":"Vic","position":0,"checkpoint":0,"splits":[]},{"name":"Jason","position":0,"checkpoint":0,"splits":[]},{"name":"Tony","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{"MC Hammer":25,"Erynn":2.5,"Rylie":2.5,"ByPotn":5}}],"name":"Minish Cap","abbr":"MC","game":"The Legend of Zelda: The Minish Cap","twitch":{"id":"5635","name":"The Legend of Zelda: The Minish Cap","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20The%20Minish%20Cap-{width}x{height}.jpg"},"next":"Tri Force Heroes Multiplayer"},"Tri Force Heroes Multiplayer":{"rules":"Race","racers":[{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Tri Force Heroes Multiplayer","abbr":"","game":"The Legend of Zelda: Tri Force Heroes","twitch":{"id":"490388","name":"The Legend of Zelda: Tri Force Heroes","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Tri%20Force%20Heroes-{width}x{height}.jpg"},"next":"Breath of the Wild Draft"},"Link Between Worlds":{"rules":"Race","racers":[{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Ashley","position":0,"checkpoint":0,"splits":[]},{"name":"Gooey","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{"DanceDad":1.23}}],"name":"Link Between Worlds","abbr":"LBW","game":"The Legend of Zelda: A Link Between Worlds","twitch":{"id":"369088","name":"The Legend of Zelda: A Link Between Worlds","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20A%20Link%20Between%20Worlds-{width}x{height}.jpg"},"next":"Battle Quest"},"Four Swords":{"rules":"Race","racers":[{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Four Swords","abbr":"FS","game":"The Legend Of Zelda: Four Swords Anniversary Edition","twitch":{"id":"33253","name":"The Legend Of Zelda: Four Swords Anniversary Edition","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20Of%20Zelda:%20Four%20Swords%20Anniversary%20Edition-{width}x{height}.jpg"},"next":"Link's Awakening"},"Phantom Hourglass":{"rules":"Race","racers":[{"name":"Alasyn","position":0,"checkpoint":0,"splits":[]},{"name":"Katie","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{"Makar":5,"Marklar":5}}],"name":"Phantom Hourglass","abbr":"PH","game":"The Legend of Zelda: Phantom Hourglass","twitch":{"id":"3359","name":"The Legend of Zelda: Phantom Hourglass","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Phantom%20Hourglass-{width}x{height}.jpg"},"next":"Cadence of Hyrule"},"Skyward Sword":{"rules":"Race","racers":[{"name":"Locke Mases Kevin","position":0,"checkpoint":0,"splits":[]},{"name":"Alasyn Rachel Sean","position":0,"checkpoint":0,"splits":[]},{"name":"Katherine Ashtyn Andy","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{"Moosen":23,"ShrtPnts":4.04}}],"name":"Skyward Sword","abbr":"SS","game":"The Legend of Zelda: Skyward Sword","twitch":{"id":"24324","name":"The Legend of Zelda: Skyward Sword","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Skyward%20Sword-{width}x{height}.jpg"},"next":"Link to the Past"},"Legend of Zelda":{"rules":"Individual Levels","racers":[{"name":"Gooey","checkpoint":0,"splits":[],"finish":null,"checkpoints":[],"warning":false,"eliminated":false,"state":""},{"name":"Mases","checkpoint":0,"splits":[],"finish":null,"checkpoints":[],"warning":false,"eliminated":false,"state":""},{"name":"Kevin","checkpoint":0,"splits":[],"finish":null,"checkpoints":[],"warning":false,"eliminated":false,"state":""},{"name":"Ashley","checkpoint":0,"splits":[],"finish":null,"checkpoints":[],"warning":false,"eliminated":false,"state":""}],"incentives":[{"name":"Filename","options":{}}],"name":"Legend of Zelda","abbr":"LoZ","game":"The Legend of Zelda","next":"Skyward Sword","twitch":{"id":"10979","name":"The Legend of Zelda","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/The%20Legend%20of%20Zelda-{width}x{height}.jpg"},"levels":[{"name":"L1","results":[]},{"name":"L2","results":[]},{"name":"L3","multiplier":2,"results":[]},{"name":"L4","multiplier":2,"results":[]},{"name":"L5","multiplier":3,"results":[]},{"name":"L6","multiplier":3,"results":[]},{"name":"L7","multiplier":4,"results":[]},{"name":"L8","multiplier":4,"results":[]},{"name":"L9","multiplier":5,"results":[]}],"state":null,"finish":null},"Zelda's Adventure":{"rules":"Race","racers":[{"name":"Kevin","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Zelda's Adventure","abbr":"ZA","game":"Zelda's Adventure","twitch":{"id":"13016","name":"Zelda's Adventure","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/Zelda%27s%20Adventure-{width}x{height}.jpg"}},"Faces of Evil":{"rules":"Race","racers":[{"name":"Kevin","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Faces of Evil","abbr":"FoE","game":"Link: The Faces of Evil","twitch":{"id":"4612","name":"Link: The Faces of Evil","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./Link:%20The%20Faces%20of%20Evil-{width}x{height}.jpg"},"next":"Board Game"},"Link's Awakening":{"rules":"Race","racers":[{"name":"Gooey","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]},{"name":"Locke","position":0,"checkpoint":0,"splits":[]},{"name":"Ashtyn","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{"THIEF":2}}],"name":"Link's Awakening","abbr":"LA","game":"The Legend of Zelda: Link's Awakening DX","twitch":{"id":"8144","name":"The Legend of Zelda: Link's Awakening DX","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Link%27s%20Awakening%20DX-{width}x{height}.jpg"},"next":"Breath of the Wild"},"Breath of the Wild":{"rules":"Bingo","racers":[{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Breath of the Wild","abbr":"BotW","game":"The Legend of Zelda: Breath of the Wild","twitch":{"id":"110758","name":"The Legend of Zelda: Breath of the Wild","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Breath%20of%20the%20Wild-{width}x{height}.jpg"},"next":"Spirit Tracks"},"Spirit Tracks":{"rules":"Race","racers":[{"name":"Mases","position":0,"checkpoint":0,"splits":[]},{"name":"Judy","position":0,"checkpoint":0,"splits":[]},{"name":"Ashtyn","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{}}],"name":"Spirit Tracks","abbr":"ST","game":"The Legend of Zelda: Spirit Tracks","twitch":{"id":"23195","name":"The Legend of Zelda: Spirit Tracks","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Spirit%20Tracks-{width}x{height}.jpg"},"next":"Oracle of Ages"},"Hyrule Warriors":{"rules":"Race","racers":[{"name":"Kevin","position":0,"checkpoint":0,"splits":[]},{"name":"Locke","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Hyrule Warriors","abbr":"HW","game":"Hyrule Warriors","twitch":{"id":"418067","name":"Hyrule Warriors","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/Hyrule%20Warriors-{width}x{height}.jpg"},"next":"Wind Waker"},"Twilight Princess":{"rules":"Royal Rumble","racers":[{"name":"Gooey","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]},{"name":"Katie","position":0,"checkpoint":0,"splits":[]},{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Sean","position":0,"checkpoint":0,"splits":[]},{"name":"Judy","position":0,"checkpoint":0,"splits":[]},{"name":"Andrew","position":0,"checkpoint":0,"splits":[]},{"name":"Rachel","position":0,"checkpoint":0,"splits":[]},{"name":"Justine","position":0,"checkpoint":0,"splits":[]},{"name":"Katherine","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Link","options":{"Balto":4.04}},{"name":"Epona","options":{}}],"name":"Twilight Princess","abbr":"TP","game":"The Legend of Zelda: Twilight Princess HD","twitch":{"id":"491327","name":"The Legend of Zelda: Twilight Princess HD","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Twilight%20Princess%20HD-{width}x{height}.jpg"},"next":"Wand of Gamelon"},"Adventure of Link":{"rules":"Race","racers":[{"name":"Mases","position":0,"checkpoint":0,"splits":[]},{"name":"Kevin","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{}}],"name":"Adventure of Link","abbr":"AoL","game":"Zelda II: The Adventure of Link","twitch":{"id":"14890","name":"Zelda II: The Adventure of Link","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./Zelda%20II:%20The%20Adventure%20of%20Link-{width}x{height}.jpg"},"next":"Twilight Princess"},"Oracle of Ages":{"rules":"Race","racers":[{"name":"Locke","position":0,"checkpoint":0,"splits":[]},{"name":"Ashley","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{"Onox":50}}],"name":"Oracle of Ages","abbr":"OoA","game":"The Legend of Zelda: Oracle of Ages","twitch":{"id":"7335","name":"The Legend of Zelda: Oracle of Ages","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Oracle%20of%20Ages-{width}x{height}.jpg"},"next":"Adventure of Link"},"Board Game":{"rules":"Race","racers":[{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Board Game","abbr":"","game":"Board Games","next":"Minish Cap","twitch":{"id":"490413","name":"Board Games","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/Board%20Games-{width}x{height}.jpg"}},"Tetra's Trackers":{"rules":"Race","racers":[{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Tetra's Trackers","abbr":"TT","game":"The Legend of Zelda: Tetra's Trackers","next":"Zelda's Adventure","twitch":{"id":"24939","name":"The Legend of Zelda: Tetra's Trackers","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Tetra%27s%20Trackers-{width}x{height}.jpg"}},"Wind Waker":{"rules":"Race","racers":[{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Rachel","position":0,"checkpoint":0,"splits":[]},{"name":"Alasyn","position":0,"checkpoint":0,"splits":[]},{"name":"Ashtyn","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{"my dude":4.04}}],"name":"Wind Waker","abbr":"WW","game":"The Legend of Zelda: The Wind Waker","twitch":{"id":"368205","name":"The Legend of Zelda: The Wind Waker HD","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20The%20Wind%20Waker%20HD-{width}x{height}.jpg"},"next":"Majora's Mask"},"Majora's Mask":{"rules":"Race","racers":[{"name":"Katie","position":0,"checkpoint":0,"splits":[]},{"name":"Ashley","position":0,"checkpoint":0,"splits":[]},{"name":"Sav","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{}}],"name":"Majora's Mask","abbr":"MM","game":"The Legend of Zelda: Majora's Mask 3D","twitch":{"id":"488533","name":"The Legend of Zelda: Majora's Mask 3D","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Majora%27s%20Mask%203D-{width}x{height}.jpg"},"next":"Minigame Olympics"},"Minigame Olympics":{"rules":"Race","racers":[],"incentives":[],"name":"Minigame Olympics","abbr":"","game":"The Legend of Zelda: A Link Between Worlds","next":"Puzzle","twitch":{"id":"369088","name":"The Legend of Zelda: A Link Between Worlds","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20A%20Link%20Between%20Worlds-{width}x{height}.jpg"}},"Puzzle":{"rules":"Race","racers":[{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Puzzle","abbr":"Puzzle","game":"Jigsaw Puzzles","twitch":{"id":"501438","name":"Jigsaw Puzzles","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/Jigsaw%20Puzzles-{width}x{height}.jpg"},"next":"Tri Force Heroes"},"Tri Force Heroes":{"rules":"Race","racers":[{"name":"Kevin","position":0,"checkpoint":0,"splits":[]},{"name":"Alasyn","position":0,"checkpoint":0,"splits":[]},{"name":"Ashley","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Tri Force Heroes","abbr":"TFH","game":"The Legend of Zelda: Tri Force Heroes","twitch":{"id":"490388","name":"The Legend of Zelda: Tri Force Heroes","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Tri%20Force%20Heroes-{width}x{height}.jpg"},"next":"Tingle's Rosy Rupeeland"},"Tingle's Rosy Rupeeland":{"rules":"Race","racers":[{"name":"Locke","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Tingle's Rosy Rupeeland","abbr":"TRR","game":"Freshly-Picked: Tingle's Rosy Rupeeland","twitch":{"id":"19367","name":"Freshly-Picked: Tingle's Rosy Rupeeland","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./Freshly-Picked:%20Tingle%27s%20Rosy%20Rupeeland-{width}x{height}.jpg"},"next":"Ocarina of Time"},"Ocarina of Time":{"rules":"Race","racers":[{"name":"Gooey","position":0,"checkpoint":0,"splits":[]},{"name":"Judy","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]},{"name":"Andrew","position":0,"checkpoint":0,"splits":[]},{"name":"Sean","position":0,"checkpoint":0,"splits":[]},{"name":"Alasyn","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{}}],"name":"Ocarina of Time","abbr":"OoT","game":"The Legend of Zelda: Ocarina of Time","twitch":{"id":"11557","name":"The Legend of Zelda: Ocarina of Time","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Ocarina%20of%20Time-{width}x{height}.jpg"},"next":"Tetra's Trackers"},"Master Quest":{"rules":"Race","racers":[{"name":"Locke","position":0,"checkpoint":0,"splits":[]}],"incentives":[{"name":"Filename","options":{"KK Buttz":3.16}}],"name":"Master Quest","abbr":"MQ","game":"The Legend of Zelda: Ocarina of Time 3D","next":"Faces of Evil","twitch":{"id":"28613","name":"The Legend of Zelda: Ocarina of Time 3D","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Ocarina%20of%20Time%203D-{width}x{height}.jpg"}},"Breath of the Wild Draft":{"rules":"Race","racers":[],"incentives":[],"name":"Breath of the Wild Draft","game":"The Legend of Zelda: Breath of the Wild","next":"Link Between Worlds","twitch":{"id":"110758","name":"The Legend of Zelda: Breath of the Wild","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/./The%20Legend%20of%20Zelda:%20Breath%20of%20the%20Wild-{width}x{height}.jpg"}},"Battle Quest":{"rules":"Race","racers":[{"name":"Josh","position":0,"checkpoint":0,"splits":[]},{"name":"Elias","position":0,"checkpoint":0,"splits":[]},{"name":"Mases","position":0,"checkpoint":0,"splits":[]},{"name":"Andy","position":0,"checkpoint":0,"splits":[]}],"incentives":[],"name":"Battle Quest","abbr":"BQ","game":"Nintendo Land","next":"Phantom Hourglass","twitch":{"id":"65960","name":"Nintendo Land","box_art_url":"https://static-cdn.jtvnw.net/ttv-boxart/Nintendo%20Land-{width}x{height}.jpg"}}}
    });

    ticker.on("change", (newValue, oldValue) => {
        if (newValue.enabled && (!oldValue || !oldValue.enabled)) {
            tick();
        }
    });

    function tick() {
        if (ticker.value.enabled) {
            advanceQueue();
            ticker.value.tick++;
            setTimeout(tick, ticker.value.duration);
        }
    }

    function advanceQueue() {
        if (queue.length === 0) {
            const nextTemplate = template.shift();
            template.push(nextTemplate);
            if (nextTemplate.template === "games") {
                const runNames = Object.keys(runs.value).filter(r => r !== "start");
                const done = runNames.filter(r => runs.value[r].state === "done" && runs.value[r].abbr).map(r => runs.value[r].abbr);
                if (done.length > 0) {
                    queue.push({
                        label: "Completed",
                        message: done.join(", ")
                    });
                }
                if (runs.value.start.current) {
                    queue.push({
                        label: "Now playing",
                        message: runs.value.start.current
                    });
                }
                if (runs.value.start.next) {
                    queue.push({
                        label: "Next up",
                        message: runs.value[runs.value.start.current].next
                    });
                }
            } else if (nextTemplate.template === "incentives") {
                let ptr = runs.value.start.current;
                while (ptr && queue.length < 3) {
                    if (runs.value[ptr].incentives && runs.value[ptr].incentives.length > 0) {
                        runs.value[ptr].incentives.forEach(incentive => {
                            const options = Object.keys(incentive.options);
                            queue.push({
                                label: `${ptr} - ${incentive.name}`,
                                message: options.length === 0 ? "No donations yet!" : options
                                    .sort((a, b) => incentive.options[b] - incentive.options[a])
                                    .filter((v, i, a) => incentive.options[v] >= (incentive.options[a[runs.value[ptr].racers.length - 1]] || 0))
                                    .map((v, i, a) => {
                                        const result = `${v} $${incentive.options[v].toFixed(2)}`;
                                        return a.length > runs.value[ptr].racers.length && incentive.options[v] === incentive.options[a[runs.value[ptr].racers.length - 1]] ?
                                            `<strong>${result}</strong>` : result;
                                    })
                                    .join(` <strong>〉</strong>`)
                            });
                        });
                    }
                    ptr = runs.value[ptr].next;
                }
                if (queue.length === 0) {
                    advanceQueue(); // no incentives left
                    return;
                }
            } else {
                queue.push(nextTemplate);
            }
        }

        message.value = queue.shift();
    }
};